---
title: 'Пример настройки с systemd'
sidebar:
    order: 2
---

import { Steps, Tabs, TabItem } from '@astrojs/starlight/components'

При запуске niri с помощью менеджера дисплеев (например, GDM), или через бинарный файл `niri-session`,
композитор запускается как сервис systemd.
Это обеспечивает необходимую интеграцию systemd для запуска программ,
таких как `mako` и сервисов, таких как `xdg-desktop-portal`, привязанных к графической сессии.

Вот пример, как вы можете настроить
[`mako`](https://github.com/emersion/mako),
[`waybar`](https://github.com/Alexays/Waybar),
[`swaybg`](https://github.com/swaywm/swaybg) и
[`swayidle`](https://github.com/swaywm/swayidle),
чтобы запускать их как сервисы systemd вместе с niri.
В отличиет от опции конфигурации `spawn-at-startup`,
такой подход позволит легко отслеживать статус и вывод этих программ,
а также перезапускать или перезагружать их.

<Steps>

1.  Установите программы, например:

    <Tabs>
        <TabItem label="Arch">
        ```shell
        sudo pacman -S mako waybar swaybg swayidle
        ```
        </TabItem>
        <TabItem label="Debian/Ubuntu">
            ```shell
            sudo apt install mako waybar swaybg swayidle # или apt-get
            ```
        </TabItem>
        <TabItem label="Fedora">
            ```shell
            sudo dnf install mako waybar swaybg swayidle
            ```
        </TabItem>
    </Tabs>

2.  Создайте директория `niri.service.wants`:

    ```shell
    mkdir -p ~/.config/systemd/user/niri.service.wants
    ```

    Это специальный каталог, который использует systemd.
    Все сервисы, связанные с ней, запускаются вместе с `niri.service`
    (это systemd-unit, используемый niri при запуске в качестве сессии).

3.  `mako` и `waybar` предоставляют сервисы systemd "из коробки", достаточно
    просто создать символьную ссылку в созданной директории:

    ```shell
    ln -s /usr/lib/systemd/user/mako.service ~/.config/systemd/user/niri.service.wants/
    ln -s /usr/lib/systemd/user/waybar.service ~/.config/systemd/user/niri.service.wants/
    ```

4.  `swaybg` не предоставляет systemd сервиса, поэтому необходимо создать его вручную.
    Создайте файл `~/.config/systemd/user/swaybg.service` и добавьте в него следующее:

    ```systemd
    [Unit]
    PartOf=graphical-session.target
    After=graphical-session.target
    Requisite=graphical-session.target

    [Service]
    ExecStart=/usr/bin/swaybg -m fill -i "%h/Изображения/Пейзаж.png"
    Restart=on-failure
    ```

    Замените путь на тот, который вам нужен. `%h` считывается как домашняя директория.

    Далее перезагрузите systemd:

    ```shell
    systemctl --user daemon-reload
    ```

    а также создайте символьную ссылку, чтобы `swaybg` запускался вместе с niri:

    ```shell
    ln -s ~/.config/systemd/user/swaybg.service ~/.config/systemd/user/niri.service.wants/
    ```

5.  `swayidle` также не предоставляет сервис systemd.
     Создайте файл `~/.config/systemd/user/swaidle.service` по аналогии с `swaybg`:

    ```systemd
    [Unit]
    PartOf=graphical-session.target
    After=graphical-session.target
    Requisite=graphical-session.target

    [Service]
    ExecStart=/usr/bin/swayidle -w timeout 601 'niri msg action power-off-monitors' timeout 600 'swaylock -f' before-sleep 'swaylock -f'
    Restart=on-failure
    ```

    Снова перезагрузите systemd:

    ```shell
    systemctl --user daemon-reload
    ```

    и создайте символьную ссылку уже для `swayidle`:

    ```shell
    ln -s ~/.config/systemd/user/swayidle.service ~/.config/systemd/user/niri.service.wants/
    ```

</Steps>

Вот и всё! Теперь все эти утилиты будут запускаться вместе с сессией niri и останавливаться при выходе из неё.
Вы также можете перезапустить программы командами наподобие этой:

```shell
systemctl --user restart waybar.service
```

Это полезно, например, при изменении их конфигурационных файлов.

## Независимый от niri запуск программ

При запуске сессии niri, выход из неё также завершит все процессы, запущенные
из неё. Однако иногда вам может понадобиться, чтобы программа, например, `tmux`
или `dtach`, продолжала работу в этом случае. Чтобы сделать это, запустите её в
переходной области видимости systemd:

```shell
systemd-run --user --scope tmux new-session
```
